# 修正版設定（THE_REQUESTを使用してダブルスラッシュを保持）
# Apache 2.4でダブルスラッシュが正規化される問題への対応

ServerName localhost

# CGIディレクトリ
ScriptAlias /cgi-bin/ /usr/local/apache2/cgi-bin/

<Directory "/usr/local/apache2/cgi-bin">
    AllowOverride None
    Options +ExecCGI
    Require all granted
    SetHandler cgi-script
</Directory>

# Rewrite設定（コンテンツページパターン - 修正版）
RewriteEngine On
LogLevel warn rewrite:trace3

# THE_REQUESTから元のコンテンツパスを取得
# THE_REQUESTには正規化される前のURLが含まれている
# パターン: "GET /site_name/content/content_path HTTP/1.1"
RewriteCond %{THE_REQUEST} "\s/(?:[^\s/]+)/content/([^\s\?]*)"
RewriteRule .* - [E=RAW_CONTENT_PATH:%1]

# コンテンツページへのリライト（環境変数RAW_CONTENT_PATHを使用）
RewriteRule ^/([a-zA-Z0-9_\-\.]+)/content/(.*)$ /cgi-bin/show.cgi?site_name=$1&content_path=%{ENV:RAW_CONTENT_PATH} [PT,L,QSA]

# ログフォーマットに環境変数を追加
LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" RAW_PATH=\"%{RAW_CONTENT_PATH}e\"" combined
